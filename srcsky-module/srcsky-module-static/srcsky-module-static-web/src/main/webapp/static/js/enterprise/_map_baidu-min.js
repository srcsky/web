KISSY.add("enterprise/_map_baidu",function(c,p,q,l){function i(e){var a=c.merge({id:"#map_canvas",zoom:15,position:[121.463538,31.24686],scrollwheel:!0,navigation:new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_ZOOM}),title:"\u4e0a\u6d77\u7f8e\u4e50\u62cd\u603b\u90e8",marker:!0,click:c.noop,markerClick:c.noop,markerDrag:c.noop,searcherEvent:c.noop,zoomChanged:c.noop,markerDraggable:!1,markers:[{icon:j}]},e);a.markers[0].point=new BMap.Point(a.position[0],a.position[1]);a.markers[0].title=
a.title;var d=new BMap.Map(h(a.id).getDOMNode(),a);d.centerAndZoom(a.markers[0].point,a.zoom);d.addControl(a.navigation);a.scrollwheel&&d.enableScrollWheelZoom();d.enableKeyboard();d.enableAutoResize();d.enableInertialDragging();d.addEventListener("click",c.bind(a.click,d));d.addEventListener("zoomend",c.bind(a.zoomChanged));d.markers=[];a.marker&&c.each(a.markers,function(b){b=new BMap.Marker(b.point,{icon:b.icon,title:b.title});b.setAnimation(BMAP_ANIMATION_DROP);a.markerDraggable&&b.enableDragging();
b.addEventListener("click",c.bind(a.markerClick,b));b.addEventListener("dragging",c.bind(a.markerDrag,b));d.addOverlay(b);d.markers.push(b)});return d}function m(e){var a=c.merge({city:"\u4e0a\u6d77",width:"auto",shop:1024,title:"\u4e0a\u6d77\u7f8e\u4e50\u62cd\u603b\u90e8",phone:"400-650-9697",address:"\u95f8\u5317\u533a\u4e00\u5929\u4e0b\u5927\u53a610B02",complete:c.noop,panel:"map_bar_line"},e),e=new BMap.InfoWindow((new l(f,{commands:{_phone:function(a,b){return 8<=b.params[0].length?b.params[0]:
"400-650-9697 \u8f6c"+b.params[0]}}})).render(a),{width:300,offset:{width:-9,height:-15}});e.addEventListener("open",function(d){var b=d.target.map,e=h(".ks_map_tmpl_container_info"),f=e.one("input"),g=e.all("p.action a").on("click",function(){g.removeClass("on");h(this).addClass("on")});e.one("p.exec a").on("click",function(){var e=h(this);c.isEmpty(f.val())?c.Window.upfail({content:"\u8bf7\u8f93\u5165\u5730\u5740",target:this,callback:function(){f.trigger("focus")}}):(c.each(d.target.map.getOverlays(),
function(a){a instanceof BMap.Polyline?b.removeOverlay(a):a instanceof BMap.Marker&&-1==b.markers.indexOf(a)&&b.removeOverlay(a)}),(new BMap.Geocoder).getPoint(f.val().trim(),function(b){if(null!=b){var f=new BMap.TransitRoute(d.target.map,{renderOptions:{map:d.target.map,panel:a.panel,autoViewport:!0},pageCapacity:3});"dt"==e.attr("method")&&(f=new BMap.DrivingRoute(d.target.map,{renderOptions:{map:d.target.map,panel:a.panel,autoViewport:!0}}));f.setSearchCompleteCallback(c.bind(a.complete,d.target.map));
"from"==g.filter("a.on").attr("method")?f.search(b,d.point):"to"==g.filter("a.on").attr("method")&&f.search(d.point,b)}else c.bind(a.complete,d.target.map)({getNumPlans:function(){return 0}})},a.city))});var i=h("ie"==c.UA.shell||"firefox"==c.UA.shell?"html":"body");i.scrollTop()>e.offset().top&&i.scrollTop(e.offset().top-20)});return e}function k(e){var a=c.merge({width:"auto",city:"\u4e0a\u6d77",shop:1024,title:"\u4e0a\u6d77\u7f8e\u4e50\u62cd\u603b\u90e8",phone:"400-650-9697",address:"\u95f8\u5317\u533a\u4e00\u5929\u4e0b\u5927\u53a610B02",
position:[116.404,39.915,15],trafficnotice:""},e);c.Window.dialog_box({content:(new l(g)).render(a),width:a.width,init:function(){this.DOM.close.addClass("aui_close_max");this.DOM.content.css({padding:"0"});var d=m({city:a.city,shop:a.shop,title:a.title,width:a.width,phone:a.phone,address:a.address,complete:function(a){var b=this;0==a.getNumPlans()?(setTimeout(function(){b.panTo(b.markers[0].getPosition())},300),h("#map_bar_view").css({width:940}),h("#map_bar_line").hide(),k.upfail({content:"Sorry\uff01\u672a\u80fd\u627e\u5230\u76f8\u5173\u8def\u7ebf\u3002"})):
(h("#map_bar_view").css({width:540}),h("#map_bar_line").show(),b.markers[0].setTop(!0),setTimeout(function(){b.setViewport([a.getStart().point,a.getEnd().point])},300))}}),b=i({id:"#map_bar_view",navigation:new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_LARGE}),title:a.title,position:a.position,zoom:parseInt(a.position[2]),markerClick:function(){b.markers[0].openInfoWindow(d)}});b.markers[0].openInfoWindow(d)},close:function(){this.DOM.close.removeClass("aui_close_max")}})}function n(c,
a){var d=document.getElementsByTagName("head")[0],b=document.createElement("script");b.type="text/javascript";b.src=c;b.onload=b.onreadystatechange=function(){if(!this.readyState||"loaded"===this.readyState||"complete"===this.readyState)a&&a(),b.onload=b.onreadystatechange=null,d&&b.parentNode&&d.removeChild(b)};d.insertBefore(b,d.firstChild)}var h=c.all,o=!1,j=null,f='  <div class="ks_map_tmpl_container_info">',f=f+'         <h5 style="font-size:14px;padding-bottom: 5px;">{{title}}</h5>',f=f+'         <p class="cgray"><\!--\u5730\u5740\uff1a--\>{{address}}</p>',
f=f+'        {{#if phone!==""}}<p><\!--\u7535\u8bdd\uff1a--\> {{_phone phone}}</p>{{/if}}',f=f+'        {{#if shop!==1024}}<p><\!--\u5e97\u94fa\uff1a--\><a href="http://shop${shop}.meilepai.com/" target="_blank" class="underl">\u8fdb\u5165\u5e97\u94fa&raquo;</a></p>{{/if}}<hr/>',f=f+'         <p class="action"><a method="from" href="javascript:void(0)" class="on">\u4ece\u8fd9\u91cc\u51fa\u53d1</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a method="to" href="javascript:void(0)">\u5230\u8fd9\u91cc\u53bb</a></p>',f=
f+'         <p class="exec" style="padding-top: 10px;"><input type="text" class="text"/>&nbsp;&nbsp;<a method="bt" href="javascript:void(0)">\u516c\u4ea4</a>&nbsp;&nbsp;<a method="dt" href="javascript:void(0)">\u9a7e\u8f66</a></p>',f=f+"     </div>",g='<div class="ks_map_m_traffic" style="width:900px;{{#if trafficnotice!==""}}height:80px{{/if}}">',g=g+'         <h2 class="fsbig">{{title}}</h2>',g=g+'         {{#if trafficnotice!==""}}<h3><strong>\u4e58\u8f66\u8def\u7ebf\uff1a</strong>{{trafficnotice}}</h3>{{/if}}',
g=g+"    </div>",g=g+'    <div id="map_bar_view" style="width: 940px;height:500px;float: left;"></div>',g=g+'    <div id="map_bar_line" style="width: 400px;height:500px;float: left;display: none; overflow-x:hidden;overflow-y:auto;"></div>';return c.Map={ready:function(e){if(o)c.bind(e,c.Map)();else{window.enterprise_map_initialize=function(){o=!0;j=new BMap.Icon("http://static.mlpui.com/static/img/_lib/map/marker5.png",new BMap.Size(40,34));BMap.Convertor={translate:function(a,b,c){var e="cbk_"+Math.round(1E4*
Math.random());n("http://api.map.baidu.com/ag/coord/convert?from="+b+"&to=4&x="+a.lng+"&y="+a.lat+"&callback=BMap.Convertor."+e);BMap.Convertor[e]=function(a){delete BMap.Convertor[e];a=new BMap.Point(a.x,a.y);c&&c(a)}}};c.bind(e,c.Map)()};var a=document.createElement("script");a.src="http://api.map.baidu.com/api?v=1.3&callback=enterprise_map_initialize";document.body.appendChild(a)}},render:i,searcher:function(e){var a=c.merge({address:"\u4e00\u5929\u4e0b\u5927\u53a6",markerDraggable:!0,markerClick:c.noop,
markerDrag:c.noop,searcherEvent:c.noop,city:"\u4e0a\u6d77",callback:function(d){if(null!=d){a.map.setCenter(d);c.each(a.map.markers,function(b){a.map.removeOverlay(b)});a.map.markers=[];var b=new BMap.Marker(d,{icon:j,title:a.title});b.setAnimation(BMAP_ANIMATION_DROP);a.markerDraggable&&b.enableDragging();b.addEventListener("click",c.bind(a.markerClick,b));b.addEventListener("dragging",c.bind(a.markerDrag,b));a.map.addOverlay(b);a.map.markers.push(b);a.searcherEvent(d)}else alert("\u8fd9\u4e2a\u5730\u5740 \u767e\u5ea6 map \u65e0\u8d44\u6599\uff01")}},
e);(new BMap.Geocoder).getPoint(a.address,a.callback,a.city)},getInfoWindow:m,window:k,register:function(e){var a=c.merge({id:"#enterprise_ui_map",position:[116.404,39.915,15],shop:1024,title:"\u4e0a\u6d77\u7f8e\u4e50\u62cd\u603b\u90e8",address:"\u95f8\u5317\u4e00\u5929\u4e0b\u5927\u53a6",phone:"400-650-9697"},e),e=h(a.id);e.one(".enterprise_ui_map_bar").on("click",function(){k({title:a.title,position:a.position,address:a.address,phone:a.phone,trafficnotice:a.trafficnotice})});return i({id:e.one(".enterprise_ui_map_body"),
title:a.title,position:a.position,zoom:parseInt(a.position[2]),scrollwheel:!1})},load_script:n}},{requires:["node","sizzle","xtemplate","enterprise/_helper","enterprise/_window"]});
